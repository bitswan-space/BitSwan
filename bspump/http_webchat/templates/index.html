<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebChat</title>

  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }
  </script>

  <script src="/static/htmx.js"></script>

  <script>
    function attachPromptFormHandler(ws) {
      const form = document.getElementById("prompt-form");
      if (!form) {
        console.warn("No prompt form found");
        return;
      }

      // Remove any previous handlers to avoid duplicates
      const clone = form.cloneNode(true);
      form.parentNode.replaceChild(clone, form);

      clone.addEventListener("submit", (e) => {
        e.preventDefault();
        const formData = new FormData(clone);
        const data = {};
        for (const [key, value] of formData.entries()) {
          data[key] = value;
        }
        ws.send(JSON.stringify({ type: "prompt_submission", data }));
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.getElementById('sidebar');
      const openSidebar = document.getElementById('open-sidebar');
      const closeBtn = document.getElementById('close-sidebar');

      if (openSidebar && sidebar) {
        openSidebar.addEventListener('click', () => {
          sidebar.classList.remove('-translate-x-full');
          openSidebar.classList.add('hidden');
        });
      }

      if (closeBtn && sidebar && openSidebar) {
        closeBtn.addEventListener('click', () => {
          sidebar.classList.add('-translate-x-full');
          openSidebar.classList.remove('hidden');
        });
      }

      const params = new URLSearchParams(window.location.search);
      const token = params.get("chat_id");

      if (token) {
        document.querySelectorAll('aside nav a').forEach((a) => {
          if (a.dataset.chatId === token) {
            a.classList.add(
              'bg-gray-400',
              'text-primary',
              'dark:bg-zinc-800',
              'dark:text-primary-dark',
              'font-semibold'
            );
          } else {
            a.classList.remove(
              'bg-gray-400',
              'text-primary',
              'dark:bg-zinc-800',
              'dark:text-primary-dark',
              'font-semibold'
            );
          }
        });
      }

      const ws = new WebSocket(`ws://${window.location.host}/ws?chat_id=${encodeURIComponent(token)}`);

      ws.onopen = () => {
        console.log("WebSocket connected, sending ready signal");
        ws.send(JSON.stringify({ type: "ready" }));
      };

      const promptEl = document.getElementById("prompt");
      const responseBox = document.getElementById("response-box");
      attachPromptFormHandler(ws);
      const responseQueue = [];
      let processing = false;

      async function processResponseQueue() {
        if (processing) return;
        processing = true;

        while (responseQueue.length > 0) {
          const el = responseQueue.shift();

          responseBox.appendChild(el);
          responseBox.scrollTop = responseBox.scrollHeight;

          await new Promise(resolve => setTimeout(resolve, 800));
        }

        processing = false;
      }

     ws.onmessage = (event) => {
    const parser = new DOMParser();
    const doc = parser.parseFromString(event.data, "text/html");
    const incomingEl = doc.body.firstElementChild;
    if (!incomingEl) return;

    if (incomingEl.tagName === "FORM") {
      promptEl.innerHTML = "";
      promptEl.appendChild(incomingEl);
      attachPromptFormHandler(ws);
    } else if (incomingEl.classList.contains("welcome-message-box")) {
      const welcomeMessageEl = document.getElementById("welcome-message");
      if (welcomeMessageEl) {
        welcomeMessageEl.innerHTML = "";
        welcomeMessageEl.appendChild(incomingEl);
      }
    } else {
      responseQueue.push(incomingEl);
      processResponseQueue();
    }
  };
    });
  </script>

  <link rel="stylesheet" href="/static/tailwind.css">
  <!-- Tailwind CSS CDN (Development) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, .dark\:bg-neutral-dark {
      transition: background-color 0.3s ease;
    }
    .fade-in {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeSlideIn 1.2s ease forwards;
      animation-delay: 0.2s;
    }
    @keyframes fadeSlideIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .-translate-x-full {
      transform: translateX(-100%);
    }

  </style>
</head>
<body class="bg-neutral dark:bg-neutral-dark flex justify-center items-center h-screen relative">
  <img src="/static/Bitswan logo.svg" class="dark:hidden fixed top-4 right-4 h-6 sm:h-8 xl:h-10">
  <img src="/static/Bitswan logo white.svg" class="hidden dark:block fixed top-4 right-4 h-6 sm:h-8 xl:h-10">

  <button
    id="open-sidebar"
    class="fixed top-4 left-4 z-30 px-3 py-2 hover:opacity-80">
    <img src="/static/menu dark.svg" class="dark:hidden w-6 sm:w-8 md:w-10">
    <img src="/static/menu white.svg" class="hidden dark:block w-6 sm:w-8 md:w-10">
  </button>

  {% include "components/side-bar.html" %}
  <div class="p-8 w-full md:w-[70%] xl:w-[60%] 2xl:w-[50%] max-w-screen-lg h-[90%] flex flex-col relative">
    <div class="flex-grow overflow-y-auto flex flex-col items-center pr-2">
      <div id="welcome-message" class="w-full px-8 pb-8 flex text-primary dark:text-primary-dark border-b border-secondary">
        {{ welcome_html | safe }}
      </div>
      <div id="response-box" class="h-[85%] w-full overflow-y-auto flex flex-col mb-12">
        {{ chat_history_html | safe }}
      </div>
      <div id="prompt" class="shadow-md rounded-xl w-[80%] px-8 py-6 border border-secondary">
        {{ current_prompt_html | safe }}
      </div>
    </div>
  </div>

  <button
    id="theme-toggle"
    onclick="
      document.documentElement.classList.toggle('dark');
      localStorage.setItem(
        'theme',
        document.documentElement.classList.contains('dark') ? 'dark' : 'light'
      );
    "
    class="fixed bottom-4 right-4 text-primary dark:text-primary-dark px-3 py-1 text-xl"
  >
    <img src="/static/brightness_2.svg" class="dark:hidden">
    <img src="/static/wb_sunny.svg" class="hidden dark:block">
  </button>
</body>
</html>
