<div id="webchat_sequence_response" class="w-full flex flex-col items-end"></div>

<script>
(function() {
  const responses = {{ responses | safe }};
  let current = 0;

  function showNext() {
    if (current >= responses.length) return;

    const responseHTML = responses[current];
    const container = document.getElementById('webchat_sequence_response');
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = responseHTML;
    const response = tempDiv.querySelector('.webchat_response');
      if (response) {
      container.appendChild(response);
    }

    if (response.id === 'webchat-response-with-prompt') {
        const formWrapper = tempDiv.querySelector('#prompt-input');
        console.log(formWrapper);
         if (formWrapper) {
        // Manually trigger the swap using htmx
        const swapTarget = document.querySelector('#prompt-input'); // The element where the form will be swapped
        if (swapTarget) {
          swapTarget.innerHTML = '';  // Clear the existing content in the target
          swapTarget.appendChild(formWrapper);  // Append the form to the target

          // Optionally, process the form so that htmx functionality is triggered
          htmx.process(formWrapper);
        }

        // Ensure the form submission is handled correctly
        waitForFormSubmission(formWrapper.querySelector('form'));
      }
    } else {
      setTimeout(showNext, 1000);
    }

    current++;
  }

   function waitForFormSubmission(form) {
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      htmx.process(form);  // Manually trigger htmx processing on form submission
    });

    document.body.addEventListener('htmx:afterRequest', function(event) {
      if (event.target === form) {
        showNext();
      }
    }, { once: true });
  }

  showNext();
})();
</script>
